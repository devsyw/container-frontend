name: Build and Push Docker Image

on:
  push:
    branches:
      - main

env:
  REGISTRY: 192.168.2.2:32000
  IMAGE_NAME: frontend

jobs:
  build:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image tag
        id: tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${SHORT_SHA}"

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} .
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Push Docker image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Update K8s manifests
        run: |
          git clone https://x-access-token:${{ secrets.K8S_REPO_TOKEN }}@github.com/devsyw/container-k8s.git
          cd container-k8s
          
          # yqë¡œ ì •í™•í•œ ê²½ë¡œì˜ íƒœê·¸ë§Œ ì—…ë°ì´íŠ¸
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_arm64
          sudo chmod +x /usr/local/bin/yq
          
          yq e '.frontend.image.tag = "${{ steps.tag.outputs.tag }}"' -i apps/container-platform/values.yaml
          
          # ë³€ê²½ í™•ì¸
          cat apps/container-platform/values.yaml | grep -A 3 "frontend:"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git diff --staged --quiet || git commit -m "chore: update frontend image to ${{ steps.tag.outputs.tag }}"
          git push origin main

      - name: Output image info
        run: |
          echo "âœ… Image pushed successfully!"
          echo "ğŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"